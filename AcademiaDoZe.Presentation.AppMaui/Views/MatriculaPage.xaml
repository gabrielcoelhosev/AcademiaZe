<?xml version="1.0" encoding="utf-8" ?>
<ContentPage xmlns="http://schemas.microsoft.com/dotnet/2021/maui"
xmlns:x="http://schemas.microsoft.com/winfx/2009/xaml"
x:Class="AcademiaDoZe.Presentation.AppMaui.Views.MatriculaPage"
xmlns:vm="clr-namespace:AcademiaDoZe.Presentation.AppMaui.ViewModels"
xmlns:enums="clr-namespace:AcademiaDoZe.Application.Enums;assembly=AcademiaDoZe.Application"
xmlns:converters="clr-namespace:AcademiaDoZe.Presentation.AppMaui.Converters"
x:DataType="vm:MatriculaViewModel"
Title="{Binding Title}">
    <ContentPage.Resources>
        <converters:FotoToImageSourceConverter x:Key="FotoToImageSourceConverter" />
        <converters:DateOnlyToDateTimeConverter x:Key="DateOnlyConverter" />
        <converters:EnumDisplayConverter x:Key="EnumDisplay" />
    </ContentPage.Resources>
    <ScrollView>
        <StackLayout Spacing="20">

            <!-- Layout principal -->

            <Border Style="{StaticResource CardBorder}" Margin="15,10">


                <StackLayout Spacing="15">
                    <!-- Busca nome do aluno -->
                    
                    
                    <Label Text="Dados do Aluno" Style="{StaticResource SubHeadline}"/>
                    <Label Text="CPF"/>
                    <Grid ColumnDefinitions="*,Auto">
                        <Entry Grid.Column="0" Text="{Binding Matricula.AlunoMatricula.Cpf}" Placeholder="000.000.000-00" Keyboard="Numeric" Margin="0,0,10,0"/>
                        <Button Grid.Column="1" Text="" Command="{Binding SearchByCpfCommand}" Style="{StaticResource ButtonPrimary}" HeightRequest="40" Padding="15,0">
                            <Button.ImageSource>
                                <FontImageSource FontFamily="MaterialIcons" Glyph="&#xe8b6;" />
                            </Button.ImageSource>
                        </Button>
                    </Grid>
                    
                    
                    
                    
                    <!-- Card somente leitura -->
                    <Border Margin="0,10,0,0" Padding="10" BackgroundColor="{AppThemeBinding Light={StaticResource Secondary}, Dark={StaticResource Gray900}}">
                        <StackLayout Spacing="10">
                            <!-- Imagem do Aluno -->
                            <Image Source="{Binding Matricula.AlunoMatricula.Foto, Converter={StaticResource FotoToImageSourceConverter}}"
               Aspect="AspectFit"
               HeightRequest="180"
               WidthRequest="180"
               HorizontalOptions="Start"
               Margin="0,10"/>
                            <!-- Dados do Aluno -->
                            <Label Text="{Binding Matricula.AlunoMatricula.Nome, StringFormat='Nome: {0}'}"/>
                            <Label Text="{Binding Matricula.AlunoMatricula.Cpf, StringFormat='CPF: {0}'}" />
                            <Label Text="{Binding Matricula.AlunoMatricula.DataNascimento, StringFormat='Nascimento: {0:dd/MM/yyyy}'}"/>
                            <Label Text="{Binding Matricula.AlunoMatricula.Email, StringFormat='Email: {0}'}"/>
                            <Label Text="{Binding Matricula.AlunoMatricula.Telefone, StringFormat='Telefone: {0}'}"/>
                        </StackLayout>
                    </Border>
                </StackLayout>
            </Border>

            <!-- Dados Pessoais -->

            <Border Style="{StaticResource CardBorder}" Margin="15,10">
                <StackLayout Spacing="15">


                    <Label Text="Láudo Médico" Style="{StaticResource SubHeadline}"/>
                        <Image Source="{Binding Matricula.LaudoMedico, Converter={StaticResource FotoToImageSourceConverter}}" 
                               Aspect="AspectFill" 
                               HeightRequest="120" 
                               WidthRequest="120">
                            <Image.GestureRecognizers>
                                <TapGestureRecognizer Command="{Binding SelecionarFotoCommand}" NumberOfTapsRequired="1" />
                            </Image.GestureRecognizers>
                        </Image>
                    <Button Text="Selecionar Imagem" Command="{Binding SelecionarFotoCommand}" Style="{StaticResource ButtonPrimary}" >
                        <Button.ImageSource>
                            <FontImageSource FontFamily="MaterialIcons" Glyph="&#xe226;" />
                        </Button.ImageSource>
                    </Button>
                </StackLayout>
 
            </Border>


            <!-- Tipo de Plano -->

            <Border Style="{StaticResource CardBorder}" Margin="15,10">
                

                <StackLayout Spacing="15">
                    <Label Text="Tipo de Plano" Style="{StaticResource SubHeadline}"/>
                    <StackLayout Spacing="5">
                        <Label Text="Plano"/>
                        <Picker ItemsSource="{Binding MatriculaPlanos}" SelectedItem="{Binding Plano}">
                            <Picker.ItemDisplayBinding>
                                <Binding Converter="{StaticResource EnumDisplay}" />
                            </Picker.ItemDisplayBinding>
                        </Picker>

                    </StackLayout>
                    <StackLayout Spacing="5">
                        <Label Text="Data de início"/>
                        <DatePicker Date="{Binding DataInicio, Converter={StaticResource DateOnlyConverter}, Mode=TwoWay}" />
                    </StackLayout>
                    <StackLayout Spacing="5">
                        <Label Text="Data Final (atualiza automaticamente)"/>
                        <DatePicker Date="{Binding DataFim, Converter={StaticResource DateOnlyConverter}, Mode=TwoWay}" />
                    </StackLayout>
                    <StackLayout Spacing="5">
                        <Label Text="Objetivo"/>
                        <Entry Text="{Binding Matricula.Objetivo}" Placeholder="Hipertofria, emagrecimento etc..."/>

                    </StackLayout>
                    <StackLayout Spacing="10">
                        <Label Text="Restrições Médicas" Style="{StaticResource SubHeadline}" />

                        <FlexLayout Wrap="Wrap" Direction="Row" AlignItems="Center" JustifyContent="Start">

                            <StackLayout Orientation="Horizontal" Margin="10,5">
                                <CheckBox IsChecked="{Binding HasDiabetes}" />
                                <Label Text="Diabetes" VerticalOptions="Center" />
                            </StackLayout>

                            <StackLayout Orientation="Horizontal" Margin="10,5">
                                <CheckBox IsChecked="{Binding HasPressaoAlta}" />
                                <Label Text="Pressão Alta" VerticalOptions="Center" />
                            </StackLayout>

                            <StackLayout Orientation="Horizontal" Margin="10,5">
                                <CheckBox IsChecked="{Binding HasLabirintite}" />
                                <Label Text="Labirintite" VerticalOptions="Center" />
                            </StackLayout>

                            <StackLayout Orientation="Horizontal" Margin="10,5">
                                <CheckBox IsChecked="{Binding HasAlergias}" />
                                <Label Text="Alergias" VerticalOptions="Center" />
                            </StackLayout>

                            <StackLayout Orientation="Horizontal" Margin="10,5">
                                <CheckBox IsChecked="{Binding HasProblemasRespiratorios}" />
                                <Label Text="Problemas Respiratórios" VerticalOptions="Center" />
                            </StackLayout>

                            <StackLayout Orientation="Horizontal" Margin="10,5">
                                <CheckBox IsChecked="{Binding HasRemedioContinuo}" />
                                <Label Text="Remédio Contínuo" VerticalOptions="Center" />
                            </StackLayout>

                        </FlexLayout>
                    </StackLayout>

                </StackLayout>
            </Border>
            <!-- Botões de Ação -->

            <Grid ColumnDefinitions="*,*" ColumnSpacing="10" Margin="15,10">

                <Button Grid.Column="0" Text="Cancelar" Command="{Binding CancelCommand}" Style="{StaticResource ButtonSecondary}" HeightRequest="50">
                    <Button.ImageSource>
                        <FontImageSource FontFamily="MaterialIcons" Glyph="&#xe5c9;" />
                    </Button.ImageSource>
                </Button>

                <Button Grid.Column="1" Text="Salvar" Command="{Binding SaveMatriculaCommand}" Style="{StaticResource ButtonPrimary}" HeightRequest="50">

                    <Button.ImageSource>
                        <FontImageSource FontFamily="MaterialIcons" Glyph="&#xe161;" />
                    </Button.ImageSource>
                </Button>
            </Grid>
            <!-- Loading Indicator -->
            <ActivityIndicator IsVisible="{Binding IsBusy}" IsRunning="{Binding IsBusy}" VerticalOptions="Center" HorizontalOptions="Center"/>

        </StackLayout>
    </ScrollView>
</ContentPage>